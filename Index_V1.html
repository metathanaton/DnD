import React, { useEffect, useMemo, useState } from 'react';

// Version sans dépendances externes (pas de Tailwind, pas de shadcn, pas de Leaflet)
// Colle ce fichier tel quel dans src/App.tsx d'un projet React + TypeScript (StackBlitz react-ts).
// Tout fonctionne en localStorage, export/import JSON, jets d100/d20, et une "carte" via liens OpenStreetMap.

// Types de données
type Caracs = {
  FOR: number;
  DEX: number;
  CON: number;
  INT: number;
  SAG: number;
  CHA: number;
};
type Competence = {
  id: string;
  nom: string;
  type: string;
  base: number;
  rang: number;
  modif: number;
};
type Equipement = {
  id: string;
  nom: string;
  type: string;
  poids: number;
  quantite: number;
  effets?: string;
  equipe?: boolean;
  slot?: string;
};
type Relation = {
  id: string;
  cible: string;
  type: string;
  intensite: number;
  notes?: string;
};
type Jet = {
  id: string;
  date: string;
  cible: string;
  base: number;
  modif: number;
  de: string;
  resultat: number;
  reussite: boolean;
  detail: string;
};
type Lieu = { id: string; nom: string; x: number; y: number; notes?: string };
type Personnage = {
  id: string;
  nom: string;
  classe: string;
  niveau: number;
  caracs: Caracs;
  pvMax: number;
  pv: number;
  initiative: number;
  chargeMax: number;
  notes?: string;
  competences: Competence[];
  equipement: Equipement[];
  relations: Relation[];
  jets: Jet[];
};
type Store = {
  persos: Personnage[];
  lieux: Lieu[];
  system: 'd100' | 'd20';
  ddBase: number;
};

// Utilitaires
const uid = () =>
  crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2);
const load = (): Store => {
  try {
    const raw = localStorage.getItem('rpg_store');
    return raw
      ? JSON.parse(raw)
      : { persos: [], lieux: [], system: 'd100', ddBase: 10 };
  } catch {
    return { persos: [], lieux: [], system: 'd100', ddBase: 10 };
  }
};
const save = (data: Store) =>
  localStorage.setItem('rpg_store', JSON.stringify(data));
const clamp = (v: number, a: number, b: number) => Math.max(a, Math.min(b, v));
const calcSeuil = (c: Competence) =>
  clamp(c.base + c.rang * 5 + c.modif, 0, 100);
const d = (n: number) => Math.floor(Math.random() * n) + 1;

// Styles minimaux en CSS-in-JS pour éviter toute dépendance
const S: Record<string, React.CSSProperties> = {
  page: {
    fontFamily: 'system-ui, Arial, sans-serif',
    padding: 16,
    background: '#0b0c0f',
    color: '#e6e7eb',
  },
  grid: { display: 'grid', gridTemplateColumns: '280px 1fr', gap: 12 },
  card: {
    background: '#151922',
    border: '1px solid #242938',
    borderRadius: 12,
    padding: 12,
  },
  btn: {
    padding: '8px 12px',
    background: '#2b3245',
    color: '#e6e7eb',
    border: '1px solid #3a4159',
    borderRadius: 8,
    cursor: 'pointer',
  },
  btnGhost: {
    padding: '6px 8px',
    background: 'transparent',
    color: '#9aa3b2',
    border: '1px solid #3a4159',
    borderRadius: 8,
    cursor: 'pointer',
  },
  input: {
    width: '100%',
    padding: 8,
    background: '#0f1320',
    color: '#e6e7eb',
    border: '1px solid #2a3144',
    borderRadius: 8,
  },
  label: { fontSize: 12, opacity: 0.8 },
  listItem: {
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'space-between',
    padding: 8,
    border: '1px solid #242938',
    borderRadius: 10,
    marginBottom: 6,
  },
  badge: {
    padding: '2px 8px',
    borderRadius: 999,
    background: '#24324a',
    border: '1px solid #38527a',
    fontSize: 12,
  },
  tabs: { display: 'flex', gap: 8, flexWrap: 'wrap' },
  tabBtn: {
    padding: '8px 12px',
    borderRadius: 8,
    border: '1px solid #3a4159',
    background: '#101524',
    color: '#cfd6e4',
    cursor: 'pointer',
  },
  tabBtnActive: {
    padding: '8px 12px',
    borderRadius: 8,
    border: '1px solid #6372a0',
    background: '#1a2235',
    color: '#fff',
    cursor: 'pointer',
  },
};

export default function App() {
  const [store, setStore] = useState<Store>(load());
  const [activeId, setActiveId] = useState<string | null>(
    store.persos[0]?.id || null
  );
  const [tab, setTab] = useState<
    'competences' | 'equipement' | 'relations' | 'jets' | 'map' | 'json'
  >('competences');
  const active = useMemo(
    () => store.persos.find((p) => p.id === activeId) || null,
    [store, activeId]
  );
  useEffect(() => {
    save(store);
  }, [store]);

  const setActive = (p: Personnage) =>
    setStore((s) => ({
      ...s,
      persos: s.persos.map((x) => (x.id === p.id ? p : x)),
    }));
  const addPerso = () => {
    const p: Personnage = {
      id: uid(),
      nom: 'Nouveau',
      classe: '',
      niveau: 1,
      caracs: { FOR: 10, DEX: 10, CON: 10, INT: 10, SAG: 10, CHA: 10 },
      pvMax: 10,
      pv: 10,
      initiative: 0,
      chargeMax: 20,
      notes: '',
      competences: [],
      equipement: [],
      relations: [],
      jets: [],
    };
    setStore((s) => ({ ...s, persos: [...s.persos, p] }));
    setActiveId(p.id);
  };
  const removePerso = (id: string) => {
    setStore((s) => ({ ...s, persos: s.persos.filter((p) => p.id !== id) }));
    if (activeId === id) setActiveId(null);
  };

  const lancerJet = (cible: string, base: number, modif: number) => {
    if (!active) return;
    const id = uid();
    const now = new Date().toISOString();
    let resultat = 0,
      reussite = false,
      detail = '';
    if (store.system === 'd20') {
      resultat = d(20);
      const total = resultat + base + modif;
      reussite = total >= store.ddBase;
      detail = `d20=${resultat} + base=${base} + modif=${modif} vs DD=${store.ddBase} => ${total}`;
    } else {
      resultat = d(100);
      const seuil = base + modif;
      reussite = resultat <= seuil;
      detail = `d100=${resultat} <= seuil=${seuil}`;
    }
    const jet: Jet = {
      id,
      date: now,
      cible,
      base,
      modif,
      de: store.system === 'd20' ? 'd20' : 'd100',
      resultat,
      reussite,
      detail,
    };
    setActive({ ...active, jets: [jet, ...active.jets] });
  };

  const exportJSON = () => {
    const blob = new Blob([JSON.stringify(store, null, 2)], {
      type: 'application/json',
    });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `rpg_export_${new Date()
      .toISOString()
      .slice(0, 19)
      .replace(/[:T]/g, '-')}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };
  const onImport = (f: File) => {
    const r = new FileReader();
    r.onload = () => {
      try {
        const data = JSON.parse(String(r.result));
        setStore(data);
        setActiveId(data.persos?.[0]?.id || null);
      } catch {
        alert('Fichier JSON invalide');
      }
    };
    r.readAsText(f);
  };

  return (
    <div style={S.page}>
      <div style={S.grid}>
        <aside style={S.card}>
          <h3 style={{ marginTop: 0 }}>Personnages</h3>
          {store.persos.map((p) => (
            <div
              key={p.id}
              style={{
                ...S.listItem,
                background: activeId === p.id ? '#0f1320' : undefined,
              }}
            >
              <button
                style={{ ...S.btnGhost, border: 'none' }}
                onClick={() => setActiveId(p.id)}
              >
                <div style={{ fontWeight: 600 }}>{p.nom || 'Sans nom'}</div>
                <div style={{ fontSize: 12, opacity: 0.7 }}>
                  {p.classe || 'classe'} · niv {p.niveau}
                </div>
              </button>
              <button style={S.btnGhost} onClick={() => removePerso(p.id)}>
                Supprimer
              </button>
            </div>
          ))}
          <button
            style={{ ...S.btn, width: '100%', marginTop: 6 }}
            onClick={addPerso}
          >
            Nouveau perso
          </button>

          <div style={{ height: 12 }} />
          <div style={{ ...S.card }}>
            <h4 style={{ marginTop: 0 }}>Système</h4>
            <div
              style={{
                display: 'flex',
                gap: 8,
                marginBottom: 8,
                alignItems: 'center',
              }}
            >
              <span style={S.label}>Mode</span>
              <select
                style={S.input as any}
                value={store.system}
                onChange={(e) =>
                  setStore({ ...store, system: e.target.value as any })
                }
              >
                <option value="d100">d100 sous seuil</option>
                <option value="d20">d20 vs DD</option>
              </select>
            </div>
            {store.system === 'd20' && (
              <div style={{ display: 'flex', gap: 8, alignItems: 'center' }}>
                <span style={S.label}>DD</span>
                <input
                  style={S.input}
                  type="number"
                  value={store.ddBase}
                  onChange={(e) =>
                    setStore({ ...store, ddBase: Number(e.target.value) })
                  }
                />
              </div>
            )}
          </div>

          <div
            style={{
              display: 'grid',
              gridTemplateColumns: '1fr 1fr',
              gap: 8,
              marginTop: 12,
            }}
          >
            <button style={S.btn} onClick={exportJSON}>
              Export
            </button>
            <label style={{ ...S.btn, textAlign: 'center' }}>
              Import
              <input
                type="file"
                accept="application/json"
                style={{ display: 'none' }}
                onChange={(e) => {
                  const f = e.target.files?.[0];
                  if (f) onImport(f);
                }}
              />
            </label>
          </div>
        </aside>

        <main style={{ display: 'flex', flexDirection: 'column', gap: 12 }}>
          {active ? (
            <>
              <section style={S.card}>
                <div
                  style={{
                    display: 'grid',
                    gridTemplateColumns: 'repeat(12, 1fr)',
                    gap: 8,
                  }}
                >
                  <div style={{ gridColumn: 'span 4' }}>
                    <div style={S.label}>Nom</div>
                    <input
                      style={S.input}
                      value={active.nom}
                      onChange={(e) =>
                        setActive({ ...active, nom: e.target.value })
                      }
                    />
                  </div>
                  <div style={{ gridColumn: 'span 3' }}>
                    <div style={S.label}>Classe</div>
                    <input
                      style={S.input}
                      value={active.classe}
                      onChange={(e) =>
                        setActive({ ...active, classe: e.target.value })
                      }
                    />
                  </div>
                  <div style={{ gridColumn: 'span 2' }}>
                    <div style={S.label}>Niveau</div>
                    <input
                      style={S.input}
                      type="number"
                      value={active.niveau}
                      onChange={(e) =>
                        setActive({ ...active, niveau: Number(e.target.value) })
                      }
                    />
                  </div>
                  <div style={{ gridColumn: 'span 3' }}>
                    <div style={S.label}>Initiative</div>
                    <input
                      style={S.input}
                      type="number"
                      value={active.initiative}
                      onChange={(e) =>
                        setActive({
                          ...active,
                          initiative: Number(e.target.value),
                        })
                      }
                    />
                  </div>

                  {(Object.keys(active.caracs) as (keyof Caracs)[]).map((k) => (
                    <div key={String(k)} style={{ gridColumn: 'span 2' }}>
                      <div style={S.label}>{k}</div>
                      <input
                        style={S.input}
                        type="number"
                        value={active.caracs[k]}
                        onChange={(e) =>
                          setActive({
                            ...active,
                            caracs: {
                              ...active.caracs,
                              [k]: Number(e.target.value),
                            },
                          })
                        }
                      />
                    </div>
                  ))}

                  <div style={{ gridColumn: 'span 2' }}>
                    <div style={S.label}>PV Max</div>
                    <input
                      style={S.input}
                      type="number"
                      value={active.pvMax}
                      onChange={(e) =>
                        setActive({ ...active, pvMax: Number(e.target.value) })
                      }
                    />
                  </div>
                  <div style={{ gridColumn: 'span 2' }}>
                    <div style={S.label}>PV</div>
                    <input
                      style={S.input}
                      type="number"
                      value={active.pv}
                      onChange={(e) =>
                        setActive({ ...active, pv: Number(e.target.value) })
                      }
                    />
                  </div>
                  <div style={{ gridColumn: 'span 3' }}>
                    <div style={S.label}>Charge max</div>
                    <input
                      style={S.input}
                      type="number"
                      value={active.chargeMax}
                      onChange={(e) =>
                        setActive({
                          ...active,
                          chargeMax: Number(e.target.value),
                        })
                      }
                    />
                  </div>
                  <div style={{ gridColumn: 'span 12' }}>
                    <div style={S.label}>Notes</div>
                    <textarea
                      style={{ ...S.input, height: 70 }}
                      value={active.notes || ''}
                      onChange={(e) =>
                        setActive({ ...active, notes: e.target.value })
                      }
                    />
                  </div>
                </div>
              </section>

              <section style={S.card}>
                <div style={S.tabs}>
                  {(
                    [
                      'competences',
                      'equipement',
                      'relations',
                      'jets',
                      'map',
                      'json',
                    ] as const
                  ).map((t) => (
                    <button
                      key={t}
                      style={tab === t ? S.tabBtnActive : S.tabBtn}
                      onClick={() => setTab(t)}
                    >
                      {t}
                    </button>
                  ))}
                </div>

                {tab === 'competences' && (
                  <div style={{ marginTop: 10 }}>
                    {active.competences.map((c) => (
                      <div key={c.id} style={S.listItem}>
                        <input
                          style={{ ...S.input, width: 160 }}
                          value={c.nom}
                          onChange={(e) =>
                            setActive({
                              ...active,
                              competences: active.competences.map((x) =>
                                x.id === c.id
                                  ? { ...c, nom: e.target.value }
                                  : x
                              ),
                            })
                          }
                        />
                        <input
                          style={{ ...S.input, width: 120 }}
                          placeholder="type"
                          value={c.type}
                          onChange={(e) =>
                            setActive({
                              ...active,
                              competences: active.competences.map((x) =>
                                x.id === c.id
                                  ? { ...c, type: e.target.value }
                                  : x
                              ),
                            })
                          }
                        />
                        <input
                          style={{ ...S.input, width: 80 }}
                          type="number"
                          value={c.base}
                          onChange={(e) =>
                            setActive({
                              ...active,
                              competences: active.competences.map((x) =>
                                x.id === c.id
                                  ? { ...c, base: Number(e.target.value) }
                                  : x
                              ),
                            })
                          }
                        />
                        <input
                          style={{ ...S.input, width: 80 }}
                          type="number"
                          value={c.rang}
                          onChange={(e) =>
                            setActive({
                              ...active,
                              competences: active.competences.map((x) =>
                                x.id === c.id
                                  ? { ...c, rang: Number(e.target.value) }
                                  : x
                              ),
                            })
                          }
                        />
                        <input
                          style={{ ...S.input, width: 70 }}
                          type="number"
                          value={c.modif}
                          onChange={(e) =>
                            setActive({
                              ...active,
                              competences: active.competences.map((x) =>
                                x.id === c.id
                                  ? { ...c, modif: Number(e.target.value) }
                                  : x
                              ),
                            })
                          }
                        />
                        <span style={S.badge}>{calcSeuil(c)}</span>
                        <button
                          style={S.btn}
                          onClick={() => lancerJet(c.nom, calcSeuil(c), 0)}
                        >
                          Lancer
                        </button>
                        <button
                          style={S.btnGhost}
                          onClick={() =>
                            setActive({
                              ...active,
                              competences: active.competences.filter(
                                (x) => x.id !== c.id
                              ),
                            })
                          }
                        >
                          Supprimer
                        </button>
                      </div>
                    ))}
                    <button
                      style={S.btn}
                      onClick={() =>
                        setActive({
                          ...active,
                          competences: [
                            ...active.competences,
                            {
                              id: uid(),
                              nom: 'Nouvelle compétence',
                              type: '',
                              base: 50,
                              rang: 0,
                              modif: 0,
                            },
                          ],
                        })
                      }
                    >
                      Ajouter
                    </button>
                  </div>
                )}

                {tab === 'equipement' && (
                  <div style={{ marginTop: 10 }}>
                    {active.equipement.map((it) => (
                      <div key={it.id} style={S.listItem}>
                        <input
                          style={{ ...S.input, width: 200 }}
                          value={it.nom}
                          onChange={(e) =>
                            setActive({
                              ...active,
                              equipement: active.equipement.map((x) =>
                                x.id === it.id
                                  ? { ...it, nom: e.target.value }
                                  : x
                              ),
                            })
                          }
                        />
                        <input
                          style={{ ...S.input, width: 110 }}
                          placeholder="type"
                          value={it.type}
                          onChange={(e) =>
                            setActive({
                              ...active,
                              equipement: active.equipement.map((x) =>
                                x.id === it.id
                                  ? { ...it, type: e.target.value }
                                  : x
                              ),
                            })
                          }
                        />
                        <input
                          style={{ ...S.input, width: 80 }}
                          type="number"
                          value={it.poids}
                          onChange={(e) =>
                            setActive({
                              ...active,
                              equipement: active.equipement.map((x) =>
                                x.id === it.id
                                  ? { ...it, poids: Number(e.target.value) }
                                  : x
                              ),
                            })
                          }
                        />
                        <input
                          style={{ ...S.input, width: 80 }}
                          type="number"
                          value={it.quantite}
                          onChange={(e) =>
                            setActive({
                              ...active,
                              equipement: active.equipement.map((x) =>
                                x.id === it.id
                                  ? { ...it, quantite: Number(e.target.value) }
                                  : x
                              ),
                            })
                          }
                        />
                        <button
                          style={S.btnGhost}
                          onClick={() =>
                            setActive({
                              ...active,
                              equipement: active.equipement.filter(
                                (x) => x.id !== it.id
                              ),
                            })
                          }
                        >
                          Supprimer
                        </button>
                      </div>
                    ))}
                    <button
                      style={S.btn}
                      onClick={() =>
                        setActive({
                          ...active,
                          equipement: [
                            ...active.equipement,
                            {
                              id: uid(),
                              nom: 'Nouvel objet',
                              type: '',
                              poids: 1,
                              quantite: 1,
                            },
                          ],
                        })
                      }
                    >
                      Ajouter
                    </button>
                  </div>
                )}

                {tab === 'relations' && (
                  <div style={{ marginTop: 10 }}>
                    {active.relations.map((r) => (
                      <div key={r.id} style={S.listItem}>
                        <input
                          style={{ ...S.input, width: 200 }}
                          value={r.cible}
                          onChange={(e) =>
                            setActive({
                              ...active,
                              relations: active.relations.map((x) =>
                                x.id === r.id
                                  ? { ...r, cible: e.target.value }
                                  : x
                              ),
                            })
                          }
                        />
                        <input
                          style={{ ...S.input, width: 120 }}
                          placeholder="type"
                          value={r.type}
                          onChange={(e) =>
                            setActive({
                              ...active,
                              relations: active.relations.map((x) =>
                                x.id === r.id
                                  ? { ...r, type: e.target.value }
                                  : x
                              ),
                            })
                          }
                        />
                        <input
                          style={{ ...S.input, width: 100 }}
                          type="number"
                          value={r.intensite}
                          onChange={(e) =>
                            setActive({
                              ...active,
                              relations: active.relations.map((x) =>
                                x.id === r.id
                                  ? { ...r, intensite: Number(e.target.value) }
                                  : x
                              ),
                            })
                          }
                        />
                        <button
                          style={S.btnGhost}
                          onClick={() =>
                            setActive({
                              ...active,
                              relations: active.relations.filter(
                                (x) => x.id !== r.id
                              ),
                            })
                          }
                        >
                          Supprimer
                        </button>
                      </div>
                    ))}
                    <button
                      style={S.btn}
                      onClick={() =>
                        setActive({
                          ...active,
                          relations: [
                            ...active.relations,
                            {
                              id: uid(),
                              cible: 'Nouveau contact',
                              type: 'allié',
                              intensite: 50,
                            },
                          ],
                        })
                      }
                    >
                      Ajouter
                    </button>
                  </div>
                )}

                {tab === 'jets' && (
                  <div style={{ marginTop: 10 }}>
                    <div
                      style={{
                        display: 'grid',
                        gridTemplateColumns: '1fr 160px 120px 120px',
                        gap: 8,
                        alignItems: 'end',
                      }}
                    >
                      <div>
                        <div style={S.label}>Cible</div>
                        <input
                          id="cible"
                          style={S.input}
                          placeholder="FOR ou Athlétisme"
                        />
                      </div>
                      <div>
                        <div style={S.label}>Base/Seuil ou Bonus</div>
                        <input
                          id="base"
                          style={S.input}
                          type="number"
                          defaultValue={50}
                        />
                      </div>
                      <div>
                        <div style={S.label}>Modif</div>
                        <input
                          id="modif"
                          style={S.input}
                          type="number"
                          defaultValue={0}
                        />
                      </div>
                      <button
                        style={S.btn}
                        onClick={() => {
                          const cible =
                            (
                              document.getElementById(
                                'cible'
                              ) as HTMLInputElement
                            ).value || 'Jet';
                          const base = Number(
                            (
                              document.getElementById(
                                'base'
                              ) as HTMLInputElement
                            ).value || 0
                          );
                          const modif = Number(
                            (
                              document.getElementById(
                                'modif'
                              ) as HTMLInputElement
                            ).value || 0
                          );
                          lancerJet(cible, base, modif);
                        }}
                      >
                        Lancer
                      </button>
                    </div>

                    <div
                      style={{
                        marginTop: 10,
                        maxHeight: 320,
                        overflow: 'auto',
                        display: 'grid',
                        gap: 6,
                      }}
                    >
                      {active.jets.map((j) => (
                        <div key={j.id} style={S.listItem}>
                          <div>
                            <div style={{ fontSize: 13 }}>
                              {new Date(j.date).toLocaleString()}
                            </div>
                            <div style={{ fontSize: 12, opacity: 0.7 }}>
                              {j.detail}
                            </div>
                          </div>
                          <span
                            style={{
                              ...S.badge,
                              background: j.reussite ? '#193a27' : '#402325',
                              borderColor: j.reussite ? '#2a6a45' : '#6b2c2f',
                            }}
                          >
                            {j.reussite ? 'OK' : 'KO'}
                          </span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}

                {tab === 'map' && (
                  <div style={{ marginTop: 10 }}>
                    <p>
                      Version sans dépendances: on affiche la liste des lieux et
                      un lien pour ouvrir sur OpenStreetMap.
                    </p>
                    {store.lieux.map((l) => (
                      <div key={l.id} style={S.listItem}>
                        <div>
                          <div style={{ fontWeight: 600 }}>{l.nom}</div>
                          <div style={{ fontSize: 12, opacity: 0.7 }}>
                            {l.x.toFixed(5)}, {l.y.toFixed(5)}
                          </div>
                        </div>
                        <div style={{ display: 'flex', gap: 8 }}>
                          <a
                            style={S.btn as any}
                            href={`https://www.openstreetmap.org/?mlat=${l.x}&mlon=${l.y}#map=14/${l.x}/${l.y}`}
                            target="_blank"
                            rel="noreferrer"
                          >
                            Ouvrir
                          </a>
                          <button
                            style={S.btnGhost}
                            onClick={() => {
                              const notes =
                                prompt('Notes', l.notes || '') || '';
                              setStore({
                                ...store,
                                lieux: store.lieux.map((x) =>
                                  x.id === l.id ? { ...l, notes } : x
                                ),
                              });
                            }}
                          >
                            Editer
                          </button>
                          <button
                            style={S.btnGhost}
                            onClick={() =>
                              setStore({
                                ...store,
                                lieux: store.lieux.filter((x) => x.id !== l.id),
                              })
                            }
                          >
                            Supprimer
                          </button>
                        </div>
                      </div>
                    ))}

                    <div
                      style={{
                        display: 'grid',
                        gridTemplateColumns: '2fr 1fr 1fr auto',
                        gap: 8,
                      }}
                    >
                      <input
                        id="lieu_nom"
                        style={S.input}
                        placeholder="Nom du lieu"
                      />
                      <input
                        id="lieu_lat"
                        style={S.input}
                        type="number"
                        placeholder="Lat"
                      />
                      <input
                        id="lieu_lng"
                        style={S.input}
                        type="number"
                        placeholder="Lng"
                      />
                      <button
                        style={S.btn}
                        onClick={() => {
                          const nom = (
                            document.getElementById(
                              'lieu_nom'
                            ) as HTMLInputElement
                          ).value;
                          const x = Number(
                            (
                              document.getElementById(
                                'lieu_lat'
                              ) as HTMLInputElement
                            ).value
                          );
                          const y = Number(
                            (
                              document.getElementById(
                                'lieu_lng'
                              ) as HTMLInputElement
                            ).value
                          );
                          if (!nom || isNaN(x) || isNaN(y)) {
                            alert('Renseigne nom/lat/lng');
                            return;
                          }
                          setStore({
                            ...store,
                            lieux: [...store.lieux, { id: uid(), nom, x, y }],
                          });
                        }}
                      >
                        Ajouter
                      </button>
                    </div>
                  </div>
                )}

                {tab === 'json' && (
                  <pre
                    style={{
                      marginTop: 10,
                      padding: 10,
                      background: '#0f1320',
                      border: '1px solid #2a3144',
                      borderRadius: 10,
                      maxHeight: 340,
                      overflow: 'auto',
                      fontSize: 12,
                    }}
                  >
                    {JSON.stringify(active, null, 2)}
                  </pre>
                )}
              </section>
            </>
          ) : (
            <section
              style={{
                ...S.card,
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                minHeight: 200,
              }}
            >
              <div>Crée un personnage pour commencer</div>
            </section>
          )}
        </main>
      </div>
    </div>
  );
}
